// lib/pages/treatment_mode_page.dart
import 'dart:math';
import 'package:flutter/material.dart';
import '../pages/record_page.dart';

class TreatmentModePage extends StatefulWidget {
  final List<Map<String, dynamic>> patients;
  final List<Map<String, dynamic>> sessionRecords;

  // ‚úÖ nullable Î°ú Î∞îÍøîÏÑú ÏóÜÏúºÎ©¥ Ìò∏Ï∂ú Ïïà Ìï®
  final Future<void> Function()? onSessionSaved;

  const TreatmentModePage({
    Key? key,
    required this.patients,
    required this.sessionRecords,
    this.onSessionSaved,
  }) : super(key: key);

  @override
  _TreatmentModePageState createState() => _TreatmentModePageState();
}

class _TreatmentModePageState extends State<TreatmentModePage> {
  late List<Map<String, dynamic>> _treatmentList;
  int _treatmentIndex = 0;
  final Map<int, List<String>> _treatmentLogs = {};
  List<String> _currentTreatments = List.filled(8, "");
  final Map<int, Map<String, dynamic>?> _vitalSignsMap = {};
  final Map<int, bool> _vitalCheckedMap = {};

  bool _finishing = false; // ‚úÖ Ï¢ÖÎ£å Ï§ë Ï§ëÎ≥µ Î∞©ÏßÄ

  @override
  void initState() {
    super.initState();
    _treatmentList = List.from(widget.patients);

    // ‚úÖ ÌïúÍ∏Ä ÎùºÎ≤® Í∏∞Ï§Ä Ïö∞ÏÑ†ÏàúÏúÑ: Í∏¥Í∏â > ÏùëÍ∏â > ÎπÑÏùëÍ∏â > ÏÇ¨Îßù
    const priorityKo = {'Í∏¥Í∏â': 0, 'ÏùëÍ∏â': 1, 'ÎπÑÏùëÍ∏â': 2, 'ÏÇ¨Îßù': 3};
    _treatmentList.sort((a, b) {
      final ak = (a['Ï†ïÎãµ'] ?? '').toString();
      final bk = (b['Ï†ïÎãµ'] ?? '').toString();
      final ai = priorityKo[ak] ?? 99;
      final bi = priorityKo[bk] ?? 99;
      return ai.compareTo(bi);
    });
  }

  // üîπ V/S ÎûúÎç§ ÏÉùÏÑ± ‚Äî ÌïúÍ∏Ä ÎùºÎ≤® Í∏∞Î∞ò
  Map<String, dynamic> generateVitalSigns(Map<String, dynamic> patient) {
    final rand = Random();
    final rr = (patient['Ìò∏Ìù°Ïàò'] ?? 20) as int;
    final triage = (patient['Ï†ïÎãµ'] ?? 'ÎπÑÏùëÍ∏â') as String;

    int sbp, dbp, hr, spo2;

    if (triage == 'ÏÇ¨Îßù') {
      sbp = 0; dbp = 0; hr = 0; spo2 = 0;
    } else if (triage == 'Í∏¥Í∏â') {
      sbp = rand.nextInt(21) + 70;   // 70~90
      dbp = rand.nextInt(21) + 40;   // 40~60
      hr  = rr > 30 ? rand.nextInt(31) + 120 : rand.nextInt(21) + 110;
      spo2 = rand.nextInt(14) + 75;  // 75~88
    } else if (triage == 'ÏùëÍ∏â') {
      sbp = rand.nextInt(21) + 90;   // 90~110
      dbp = rand.nextInt(21) + 60;   // 60~80
      hr  = rand.nextInt(21) + 100;  // 100~120
      spo2 = rand.nextInt(8) + 88;   // 88~95
    } else { // ÎπÑÏùëÍ∏â
      sbp = rand.nextInt(21) + 110;  // 110~130
      dbp = rand.nextInt(21) + 70;   // 70~90
      hr  = rand.nextInt(21) + 80;   // 80~100
      spo2 = rand.nextInt(5) + 95;   // 95~99
    }

    return {"SBP": sbp, "DBP": dbp, "HR": hr, "SpO2": spo2};
  }

  void _addTreatment(String action) {
    setState(() {
      if (_currentTreatments.contains(action)) return;
      final idx = _currentTreatments.indexOf("");
      if (idx != -1) {
        _currentTreatments[idx] = action;
        final patientIdx = _treatmentIndex;
        _treatmentLogs.putIfAbsent(patientIdx, () => []);
        _treatmentLogs[patientIdx]!.add(action);
      }
    });
  }

  Future<void> _nextTreatment() async {
    if (_treatmentIndex < _treatmentList.length - 1) {
      setState(() {
        _treatmentIndex++;
        _currentTreatments = List.filled(8, "");
      });
      return;
    }

    if (_finishing) return;
    _finishing = true;

    // ‚úÖ ÏöîÏïΩ Îã§Ïù¥ÏñºÎ°úÍ∑∏ Îã´Ìûå Îí§ ÏßÑÌñâ
    await _showTreatmentSummary();

    // ‚úÖ ÏÑ∏ÏÖò Ï†ÄÏû• ÏΩúÎ∞±Ïù¥ ÏûàÏúºÎ©¥ Ìïú Î≤àÎßå Ìò∏Ï∂ú
    if (widget.onSessionSaved != null) {
      await widget.onSessionSaved!();
    }

    if (!mounted) return;
    Navigator.pushReplacement(
      context,
      MaterialPageRoute(builder: (_) => const RecordPage()),
    );
  }

  Future<void> _showTreatmentSummary() async {
    final buf = StringBuffer();
    for (int i = 0; i < _treatmentList.length; i++) {
      final p = _treatmentList[i];
      buf.writeln('${i + 1}Î≤à ÌôòÏûê (${p['Ï†ïÎãµ'] ?? 'ÎØ∏Ï†ï'})');
      final logs = _treatmentLogs[i] ?? const <String>[];
      for (final t in logs) {
        buf.writeln('  - $t');
      }
      buf.writeln();
    }

    await showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: const Text('Ï≤òÏπò ÏöîÏïΩ'),
        content: SingleChildScrollView(child: Text(buf.toString())),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context), child: const Text('ÌôïÏù∏')),
        ],
      ),
    );
  }

  Widget _buildPatientCardFull(Map<String, dynamic> patient) {
    final bool checked = _vitalCheckedMap[_treatmentIndex] ?? false;
    final vs = _vitalSignsMap[_treatmentIndex];

    Color getColorKo(String triageKo) {
      switch (triageKo) {
        case 'Í∏¥Í∏â': return Colors.red;
        case 'ÏùëÍ∏â': return Colors.yellow[700]!;
        case 'ÎπÑÏùëÍ∏â': return Colors.green;
        case 'ÏÇ¨Îßù': return Colors.black;
        default: return Colors.grey;
      }
    }

    final triageKo = (patient['Ï†ïÎãµ'] ?? 'ÎØ∏Î∂ÑÎ•ò') as String;
    final triageColor = getColorKo(triageKo);
    final triageTextColor = triageKo == 'ÏÇ¨Îßù' ? Colors.white : Colors.black;

    return Card(
      elevation: 4,
      margin: const EdgeInsets.all(12),
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (patient['image'] != null)
                  Image.asset(
                    patient['image'],
                    width: 180,
                    height: 220,
                    fit: BoxFit.contain,
                  ),
                const SizedBox(width: 12),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Expanded(
                            child: Text('üó£ ${patient['speech']}', style: const TextStyle(fontSize: 16)),
                          ),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                            decoration: BoxDecoration(
                              color: triageColor,
                              borderRadius: BorderRadius.circular(6),
                            ),
                            child: Text(
                              triageKo,
                              style: TextStyle(
                                color: triageTextColor,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ),
                        ],
                      ),
                      Text('ü©∏ Ï¶ùÏÉÅ: ${patient['injury']}', style: TextStyle(color: Colors.red[700])),
                      const SizedBox(height: 8),
                      Text('üßë ÏÑ±Î≥Ñ: ${patient['gender']}'),
                      Text('üéÇ ÎÇòÏù¥: ${patient['age']}ÏÑ∏'),
                      Text('üö∂ Î≥¥Ìñâ: ${patient['canWalk'] == true ? "Í∞ÄÎä•" : "Î∂àÍ∞Ä"}'),
                      const SizedBox(height: 12),
                      checked && vs != null
                          ? Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                const Text('ü©∫ V/S Ï∏°Ï†ï Í≤∞Í≥º', style: TextStyle(fontWeight: FontWeight.bold)),
                                const SizedBox(height: 4),
                                Text('BP: ${vs['SBP']}/${vs['DBP']} mmHg'),
                                Text('HR: ${vs['HR']} Ìöå/Î∂Ñ'),
                                Text('SpO‚ÇÇ: ${vs['SpO2']} %'),
                              ],
                            )
                          : ElevatedButton(
                              onPressed: () {
                                setState(() {
                                  _vitalSignsMap[_treatmentIndex] = generateVitalSigns(patient);
                                  _vitalCheckedMap[_treatmentIndex] = true;
                                });
                              },
                              child: const Text('V/S Ï∏°Ï†ï'),
                            ),
                    ],
                  ),
                ),
              ],
            ),
            const SizedBox(height: 8),
            const Divider(),
            const Text('ü©∫ Ï≤òÏπò Í∏∞Î°ù', style: TextStyle(fontWeight: FontWeight.bold)),
            const SizedBox(height: 6),
            SizedBox(
              height: 40,
              child: GridView.builder(
                physics: const NeverScrollableScrollPhysics(),
                gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                  crossAxisCount: 8,
                  mainAxisSpacing: 4,
                  crossAxisSpacing: 4,
                  childAspectRatio: 2.5,
                ),
                itemCount: _currentTreatments.length,
                itemBuilder: (_, idx) {
                  final t = _currentTreatments[idx];
                  return Container(
                    alignment: Alignment.center,
                    decoration: BoxDecoration(
                      border: Border.all(color: Colors.grey),
                      borderRadius: BorderRadius.circular(4),
                      color: t.isEmpty ? Colors.white : Colors.blue[100],
                    ),
                    child: Text(t.isEmpty ? '‚ñ°' : t, style: const TextStyle(fontSize: 11)),
                  );
                },
              ),
            ),
          ],
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final p = _treatmentList[_treatmentIndex];

    return Scaffold(
      appBar: AppBar(title: const Text('Ï≤òÏπòÎ∞ò Î™®Îìú')),
      body: SingleChildScrollView(
        child: Column(
          children: [
            _buildPatientCardFull(p),
            const SizedBox(height: 12),
            Wrap(
              spacing: 8,
              runSpacing: 8,
              children: [
                ElevatedButton(onPressed: () => _addTreatment('ÏßÄÌòà'), child: const Text('ÏßÄÌòà')),
                ElevatedButton(onPressed: () => _addTreatment('O‚ÇÇ'), child: const Text('O‚ÇÇ')),
                ElevatedButton(onPressed: () => _addTreatment('AED'), child: const Text('AED')),
                ElevatedButton(onPressed: () => _addTreatment('IV'), child: const Text('IV')),
                ElevatedButton(onPressed: () => _addTreatment('ÏÉÅÏ≤ò ÎìúÎ†àÏã±'), child: const Text('ÏÉÅÏ≤ò ÎìúÎ†àÏã±')),
                ElevatedButton(onPressed: () => _addTreatment('Î∂ÄÎ™©'), child: const Text('Î∂ÄÎ™©')),
                ElevatedButton(onPressed: () => _addTreatment('Í≤ΩÏ∂îÎ≥¥Ìò∏ÎåÄ'), child: const Text('Í≤ΩÏ∂îÎ≥¥Ìò∏ÎåÄ')),
                ElevatedButton(onPressed: () => _addTreatment('Ï†ÑÎ¨∏Í∏∞ÎèÑÏà†'), child: const Text('Ï†ÑÎ¨∏Í∏∞ÎèÑÏà†')),
                ElevatedButton(onPressed: () => _addTreatment('ÏóêÌîºÎÑ§ÌîÑÎ¶∞'), child: const Text('ÏóêÌîºÎÑ§ÌîÑÎ¶∞')),
                ElevatedButton(onPressed: () => _addTreatment('ÏàòÏï°'), child: const Text('ÏàòÏï°')),
              ],
            ),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: _finishing ? null : _nextTreatment,
              child: Text(
                _treatmentIndex < _treatmentList.length - 1
                    ? 'Ï≤òÏπò ÏôÑÎ£å ‚Üí Îã§Ïùå ÌôòÏûê'
                    : 'Î™®Îì† ÌôòÏûê Ï≤òÏπò ÏôÑÎ£å',
              ),
            ),
          ],
        ),
      ),
    );
  }
}
